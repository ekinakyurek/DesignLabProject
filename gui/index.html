<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=240, initial-scale=1">
    <title>I am a Mug</title>
    <link rel="stylesheet" type="text/css" href="jquery.fullPage.css" />
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script type="text/javascript" src="jquery.fullPage.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <style type="text/css">
        ::-webkit-scrollbar {
            display: none;
        }

        div#WikiData0 {
            text-align: center;
        }

        div#WikiData1 {
            text-align: center;
        }

        div#header0 {
            height: 28px;
            background: rgba(128, 128, 128, 0.6);
            width: 100%;
            margin: 0px auto;
            text-align: center;
        }

        p#articleBody0 {
            color: #FFF;
        }

        p#desc0 {
            color: #FFF;
            font-weight: bold;
        }

        p#info0 {
            color: #FFF;
            vertical-align: middle;
            font-style: bold;
            font-family: "Verdana";
        }

        img {
            width: 80%;
            padding-top: 0;
            display: block;
            margin-top: 0;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>
<body>
    <script type="text/javascript">
        $(document).ready(function () {
            $('#fullpage').fullpage({
                sectionsColor: ['#000'],
                paddingBottom: '20px',
                controlArrows: false,
                loopHorizontal: false,
                autoScrolling: false,
                scrollBar: false,
                responsiveWidth: 400,
                scrollingSpeed: 500
            });
        });
    </script>
    <script>
        'use strict'
        var ee = require('electron').ipcRenderer;
        var remote = require('electron').remote;
        var https = require('https')
        var net = require('net');
        var client = new net.Socket();
        var event_emitter = require('events').EventEmitter;

        var countClick = 0;
        var countSlideLeft = 0;
        var countSlideRight = 0;
        var countMoveSectionUp = 0;
        var countMoveSectionDown = 0;

        var section_count = 0;
        var dataLength = 0;
        var count = '5';
        var format = 'xml';
        var startIndex = '1';
        var onprocess = false;
        var debug = true;
        var searchTerm = "";
        var idCount = 0;
        var KEY = 'AIzaSyDoTp6UicPtIH_JVy-cFwoebTEp9-rRHYE';
        var CX = '007548910499588559159:lepkrgs8oig';
        var api_host = 'kgsearch.googleapis.com';
        var api_key = 'AIzaSyDoTp6UicPtIH_JVy-cFwoebTEp9-rRHYE';
        var resultStorage = [];
        var imageArray = [];

        var fs = require('fs');
        var util = require('util');
        var log_file = fs.createWriteStream(__dirname + '/debug.log', { flags: 'w' });
        var log_stdout = process.stdout;
        var kg_ee = new event_emitter();
        
	var my_console_log = function (d) { //
            if (util != null) {
                log_file.write(util.format(d) + '\n');
                log_stdout.write(util.format(d) + '\n');
            } else {
                console.log(d);
            }
        };

        ee.on("swipe-up,2", function (data) {
            countSlideRight++;
            my_console_log("2: slide right gesture is called");
            $.fn.fullpage.moveSlideRight();
        });
        ee.on("swipe-down,1", function (data) {
            countSlideRight++;
            my_console_log("1: slide right gesture is called");
            $.fn.fullpage.moveSlideRight();
        });

        ee.on("swipe-down,2", function (data) {
            countSlideLeft++;
            my_console_log("2: slide left gesture is called");
            $.fn.fullpage.moveSlideLeft();
        });
        ee.on("swipe-up,1", function (data) {
            countSlideLeft++;
            my_console_log("1: slide left gesture is called");
            $.fn.fullpage.moveSlideLeft();
        });

        var handle_section_changes = function(direction){
            if(!direction){
                section_count++;
                countMoveSectionDown++;
            }else{
                section_count--;
                countMoveSectionUp++
            }

            if (resultStorage.length <= section_count || imageArray.length <= section_count ) {
                section_count--;
            }else if(section_count < 0){
                section_count++
            } else {
                var name = resultStorage[section_count]['name'] || resultStorage[section_count]['description'];
                document.getElementById("info0").innerHTML = name;
                var description = resultStorage[section_count]['description'] || resultStorage[section_count]['detailedDescription']['articleBody'];

                document.getElementById("desc0").innerHTML = description;
                document.getElementById("WikiData0").innerHTML = resultStorage[section_count]['detailedDescription']['articleBody'];

                document.getElementById("img0").src = imageArray[section_count][0];
                document.getElementById("img1").src = imageArray[section_count][1];
                document.getElementById("img2").src = imageArray[section_count][2];
                document.getElementById("img3").src = imageArray[section_count][3];
                document.getElementById("img4").src = imageArray[section_count][4];
            }
            var log_direction  = direction ? 'moveSectionUp':'moveSectionDown';
            my_console_log("After" + log_direction +" section_count is: " + section_count)
        }

        ee.on("swipe-down,0", function (data) {

          handle_section_changes(false);
        });

        ee.on("swipe-up,0", function (data) {
            handle_section_changes(true)
        });

        var api_key = 'AIzaSyDoTp6UicPtIH_JVy-cFwoebTEp9-rRHYE';
        var api_host = 'kgsearch.googleapis.com';

        var main = function (test_input, my_event_emitter) {

            var words = [];
            var roots = [];
            var roots_type = [];
            var printed_results = [];
            var isSomethingFound = false;

            var search_word = function (phrase, callback, limit) {
                if (debug) my_console_log('Searching for phrase :' + phrase);

                if (limit == undefined) {
                    limit = 1;
                }

                var query_string = '/v1/entities:search?languages=tr&query=' + phrase + '&key=' + api_key + '&limit=1&indent=True'
                query_string = encodeURI(query_string)
                //my_console_log(query_string)
                https.get({

                    host: api_host,
                    path: query_string
                }, function (response) {
                    // Continuously update stream with data
                    var body = '';
                    response.on('data', function (d) {
                        body += d;
                    });
                    response.on('end', function () {
                        var response = JSON.parse(body);
                        var succeed = true;
                        // control if it was succeed
                        if (debug) my_console_log('Response for phrase :' + phrase + '\n');
                        if (debug) my_console_log(response);

                        if (response.hasOwnProperty('@context')) {
                            succeed = true;

                            var itemListElement = response['itemListElement'][0]
                            if (debug) my_console_log('ItemlistElement for phrase : ' + phrase);
                            if (debug) my_console_log(itemListElement);
                            //my_console_log(itemListElement['result']);
                            ///my_console_log(itemListElement['resultScore']);
                            if (itemListElement != [] && itemListElement != undefined) {
                                if (debug) my_console_log('Callback for phrase : ' + phrase);
                                callback(succeed, itemListElement['result'], itemListElement['resultScore'])
                            } else {
                                if (debug) my_console_log('Failed callback for phras : ' + phrase + '\n');
                                callback(true, null, null)
                            }
                        } else {
                            if (debug) my_console_log('Failed result for phrase : ' + phrase);
                            callback(false, null, null)
                        }


                        //my_console_log(response)
                    });
                });
            }

            //testing
            // search_word('google', function(result, response){});

            var init_state_machine = function (input) {
                if (debug) my_console_log('State machine is initialized with input: ')
                if (debug) my_console_log(input);

                var input_array = input.split(" ");
                words = input_array.slice(0, input_array.length / 2);
                var temp_roots = input_array.slice(input_array.length / 2, input_array.length);

                for (var i = 0; i < temp_roots.length; i++) {
                    var root_and_type = temp_roots[i].split(',');

                    roots_type.push(root_and_type[1]);
                    roots.push(root_and_type[0]);
                }
                if (debug) my_console_log('Input words : ');
                if (debug) my_console_log(words);
                if (debug) my_console_log('Input roots : ');
                if (debug) my_console_log(roots);

                first_search(0);
            }

            var first_search = function (index) {

                search_word(words[index], function (isSucceed, result, score) {

                    if (isSucceed) {
                        if (debug) my_console_log('Callback for word is succeed :' + words[index]);
                        if (score != null) {
                            if (index + 1 < words.length) {
                                if (debug) my_console_log('Word is going to iteration : ' + words[index]);
                                iterasyon(result, score, index + 1, words[index])
                            } else {
                                if (roots_type[index] == 'Noun') {
                                    if (debug) my_console_log('last word is noun here is the result of :' + words[index])
                                    if (debug) my_console_log(result);
                                    printed_results.push(result);
                                    isSomethingFound = true
                                    if (my_event_emitter != null) my_event_emitter.emit('result', result)
                                } else {
                                    if (debug) my_console_log('last word is not noun :' + words[index])
                                    if (debug) my_console_log(result);
                                    //save for causion
                                }
                                finish();
                            }
                        } else {
                            if (debug) my_console_log('Word is going to root_serach : ' + words[index]);
                            root_search(index)
                        }
                    } else {
                        if (debug) my_console_log('Callback for word is failed :' + words[index]);
                    }
                })
            }

            var root_search = function (index) {
                search_word(roots[index], function (isSucceed, result, score) {
                    if (isSucceed) {
                        if (debug) my_console_log('Callback for root is succeed :' + roots[index]);
                        if (score != null) {
                            if (index + 1 < words.length) {
                                if (debug) my_console_log('Root is going to iteration : ' + roots[index]);
                                iterasyon(result, score, index + 1, roots[index])
                            } else {
                                if (roots_type[index] == 'Noun') {
                                    if (debug) my_console_log('Last root is noun here is the result of :' + roots[index])
                                    if (debug) my_console_log(result);
                                    printed_results.push(result);
                                    isSomethingFound = true
                                    if (my_event_emitter != null) my_event_emitter.emit('result', result);
                                } else {
                                    if (debug) my_console_log('Last root is not noun :' + roots[index])
                                    if (debug) my_console_log(result);
                                    //save for causion
                                }
                            }
                        } else {
                            if (debug) my_console_log('Zero score even in the root. It is going next word search :' + roots[index])
                            if (debug) my_console_log(result);
                            first_search(index + 1)
                        }
                    } else {
                        if (debug) my_console_log('Callback for root is failed :' + roots[index]);
                    }
                })
            }
            var iterasyon = function (result, score, index, phrase) {
                var new_phrase = phrase + ' ' + words[index];
                if (debug) my_console_log('Iteration for phrase : ' + new_phrase);

                search_word(new_phrase, function (isSucceed, result2, score2) {
                    if (isSucceed) {
                        if (debug) my_console_log('Callback for iteration phrase is succeed :' + new_phrase);
                        if (debug) my_console_log('Score for phrase is' + score2 + ' : ' + new_phrase)
                        if (score2 != null && score2 >= score) {
                            if (debug) my_console_log('iteration phrase is going next iteration :' + new_phrase);
                            iterasyon(result2, score2, index + 1, new_phrase)
                        } else if (score2 == null || score2 < score) {
                            if (debug) my_console_log('iteration phrase is going root iteration :' + new_phrase);
                            root_iterasyon(result, score, index, phrase)
                        }
                    } else {
                        if (debug) my_console_log('Callback for iteration phrase is failed :' + new_phrase);
                    }
                })
            }

            var root_iterasyon = function (result, score, index, phrase) {
                var new_phrase = phrase + ' ' + roots[index];
                if (debug) my_console_log('Root iteration for phrase : ' + new_phrase);
                search_word(new_phrase, function (isSucceed, result2, score2) {
                    if (isSucceed) {
                        if (debug) my_console_log('Callback for root iteration phrase is succeed :' + new_phrase);
                        if (debug) my_console_log('Score for phrase is' + score2 + ' : ' + new_phrase)
                        if (score2 != null && score2 >= score) {
                            if (debug) my_console_log('Root iteration phrase is going next iteration :' + new_phrase);
                            iterasyon(result2, score2, index + 1, new_phrase)
                        } else if (score2 == null || score2 < score) {
                            if (debug) my_console_log('Root iteration phrase is going to matching :' + new_phrase);
                            matching(result, score, index, phrase)
                        }
                    } else {
                        if (debug) my_console_log('Callback for root iteration phrase is failed :' + new_phrase);
                    }
                })
            }

            var matching = function (result, score, index, phrase) {
                if (debug) my_console_log('Matching result for phrase : ' + phrase + '\n');
                if (debug) my_console_log(result)

                var words_unreached = words.slice(index, words.length)
                if (result.name != undefined) {
                    var result_unreached = result.name.toLowerCase().replace(phrase, '').split(" ").splice(1)
                } else {
                    var result_unreached = result.description.toLowerCase().replace(phrase, '').split(" ").splice(1)
                }

                var found = false;

                var last_index = index;

                for (var i = 0; i < result_unreached.length; i++) {

                    if (i < words_unreached.length) {

                        if (words_unreached[i].length > result_unreached[i].length) {
                            if (words_unreached[i].indexOf(result_unreached[i]) != -1) {
                                index = index + 1
                                found = true
                            } else {
                                break;

                            }
                        } else {
                            if (result_unreached[i].indexOf(words_unreached[i]) != -1) {
                                found = true;
                                index = index + 1
                            } else {
                                break;
                            }
                        }
                    } else {
                        break;
                    }

                }

                if (phrase.split(" ").length == 1 && roots_type[last_index] == 'Noun') {
                    if (debug) my_console_log('Result for phrase will be printed : ' + phrase);
                    printed_results.push(result);
                    isSomethingFound = true
                    if (my_event_emitter != null) my_event_emitter.emit('result', result)

                } else if (phrase.split(" ").length > 1) {
                    if (debug) my_console_log('Result for phrase will be printed : ' + phrase);
                    printed_results.push(result);
                    isSomethingFound = true
                    if (my_event_emitter != null) my_event_emitter.emit('result', result)
                    //print that results
                } else {
                    if (debug) my_console_log('Result for phrase will not be printed because it is not noun : ' + phrase);
                }

                if (index < words.length) {
                    if (debug) my_console_log('System goes new search ');
                    first_search(index);
                } else {
                    if (debug) my_console_log('System will be shutdown')
                    finish()
                }
            }



            var finish = function () {
                if (debug) my_console_log('finish')
                if (!isSomethingFound) {
                    cnt = 0;
                    imgcnt = 0;
                    my_console_log('Nothing found');


                    if (debug) my_console_log('Nothing found');
                    if (event_emitter != null) {
                        event_emitter.emit("error", 'Nothing found')
                    }
                }
                if (debug) my_console_log('-----------------Printed Results------------------------');
                else console.log('-----------------Printed Results------------------------');
                for (var i = 0 ; i < printed_results.length; i++) {
                    if (printed_results[i].name != undefined) {
                        var name = printed_results[i].name
                    } else {
                        var name = printed_results[i].description
                    }
                    if (debug) my_console_log(name);
                    else console.log(name);
                }

                //evaluate if nothing is printed
            }


            init_state_machine(test_input);
        }

        ee.on("click-event,2", function (data) {
            my_console_log("2:click detected at point:" + data);
            countClick++;
            if (!onprocess) {
                onprocess = true;
                document.getElementById("desc0").innerHTML = "ARIYORUM";

                client.connect(10000, 'localhost', function () {
                    my_console_log('Connected');
                    client.write('Start');
                });

                client.on('close', function () {
                    my_console_log('Connection closed');
                    onprocess = false
                });

                client.on('data', function (data) {
                    my_console_log('Data received from stt: ' + data);
                    searchTerm = data.toString();

                    var test_input = searchTerm;
                    my_console_log('SearchTerm from microphone:' + test_input);
                    //var texturlTR = "https://tr.wikipedia.org/w/api.php?format=" + format + "&action=query&prop=extracts&exintro=&explaintext=&titles=" + searchTerm;
                    //my_console_log(texturlTR)
                    //var yandexTanslateURL = "https://translate.yandex.net/api/v1.5/tr.json/translate?key=trnsl.1.1.20161109T203752Z.31a66f7b078518f9.4cfb304a7f2d5dadbb4aa80ac4261c70258e5816&text=" + searchTerm + "&lang=tr-en&format=json"
                    // my_console_log(yandexTanslateURL)
                    // ----receive function----v
		
                    var kg_ee = new event_emitter();
		   
		  if(test_input != ''){
		    main(test_input, kg_ee)
                    var received_result_no = 0;
		  }else{
			kg_ee.emit('error', "NothingFound");
		  }
                  kg_ee.on("result", function (data) {
                        var name = data.name || data.description;
                        var description = data.description || data.detailedDescription.articleBody;

                        if(received_result_no == 0){
                            section_count = 0;
                            resultStorage.length = 0;
                            imageArray.length = 0;
                            resultStorage.push(data);

                            document.getElementById("info0").innerHTML = name;
                            document.getElementById("desc0").innerHTML = description;
                            document.getElementById("WikiData0").innerHTML = data.detailedDescription.articleBody;

                            var url = "https://www.googleapis.com/customsearch/v1?q=" + name + "&num=" + count + "&start=" + startIndex + "&key=" + KEY + "&cx=" + CX + "&searchType=image";

                            $.getJSON(url, function (data) {
                                document.getElementById("img0").src = data.items[0].link;
                                document.getElementById("img1").src = data.items[1].link;
                                document.getElementById("img2").src = data.items[2].link;
                                document.getElementById("img3").src = data.items[3].link;
                                document.getElementById("img4").src = data.items[4].link;
                            });
                        }else{
                                resultStorage.push(data);
                        }

                        received_result_no++;
                        var url = "https://www.googleapis.com/customsearch/v1?q=" + name + "&num=" + count + "&start=" + startIndex + "&key=" + KEY + "&cx=" + CX + "&searchType=image";
                        my_console_log('Image Search URL: '+ url)
                        $.getJSON(url, function (data) {
                            console_log(data)
                            if(received_result_no) {
                                document.getElementById("img0").src = data.items[0].link;
                                document.getElementById("img1").src = data.items[1].link;
                                document.getElementById("img2").src = data.items[2].link;
                                document.getElementById("img3").src = data.items[3].link;
                                document.getElementById("img4").src = data.items[4].link;
                            }
                        });

                        imageArray.push(data.items.map(function (item) { return item.link; }));
                    });

                    kg_ee.on('error', function(data){
                        document.getElementById("info0").innerHTML = "Nothing Here";
                        document.getElementById("desc0").innerHTML = "I couldn't find anytihng";
                        document.getElementById("WikiData0").innerHTML = "I am sorry :(";
                        document.getElementById("img0").src = "travolta.gif";
                        document.getElementById("img1").src = "travolta.gif";
                        document.getElementById("img2").src = "travolta.gif";
                        document.getElementById("img3").src = "travolta.gif";
                        document.getElementById("img4").src = "travolta.gif";
                    })

                    client.destroy(); // kill client after server's response
                });
            }

        });

    </script>

    <div id="fullpage">

        <div class="section active" id="section0">
            <div id="header0"><p id="info0">Hello</p><p id="desc0">Hello</p></div>

            <div class="slide">
                <div class="intro" id="WikiData0">
                    <p>Hello</p>
                </div>
            </div>
            <div class="slide">
                <div class="intro">
                    <img class="img-responsive" id="img0" src="1.jpg" />
                </div>
            </div>
            <div class="slide">
                <div class="intro">
                    <img class="img-responsive" id="img1" src="1.jpg" />
                </div>
            </div>
            <div class="slide">
                <div class="intro">
                    <img class="img-responsive" id="img2" src="1.jpg" />
                </div>
            </div>
            <div class="slide">
                <div class="intro">
                    <img class="img-responsive" id="img3" src="1.jpg" />
                </div>
            </div>
            <div class="slide">
                <div class="intro">
                    <img class="img-responsive" id="img4" src="1.jpg" />
                </div>
            </div>
        </div>
    </div>

</body>
</html>
